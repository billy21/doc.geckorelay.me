(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{157:function(t,e,r){"use strict";r.r(e);var s=r(0),a=Object(s.a)({},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),r("p",[t._v("由于中国大陆内存在 DNS 缓存投毒，通过常规方式使用 DNS 会导致某些域名不能被正常解析。DNSSEC 曾经是被寄予厚望来解决 DNS 缓存投毒的方案， 然而由于大部分域名都未设置 DNSSEC，不能直接在 DNS 客户端使用强制 DNSSEC 校验并对校验失败的结果丢弃，因此 DNSSEC 在对抗 DNS 污染时并没有起到预想中的效果。反而，在执行 DNSSEC 查询时，即使是未被屏蔽的域名也可能遭受污染。")]),t._v(" "),r("p",[t._v("既然使用标准 DNS 协议会被污染，那最简单的方案就是在公网内使用非常规的 DNS 查询方法，并且把 DNS 查询内容加密，自然也就规避了 ISP 的 DNS 劫持和防火墙的 DNS 缓存投毒。")]),t._v(" "),r("p",[t._v("目前主流的方法主要是 DNS over HTTPS（DoH）和 DNS over TLS（DoT），本文档介绍第一种方案。")]),t._v(" "),r("p",[t._v("支持 DNS over HTTPS 的 DNS 程序非常多，然而大部分主要用于在核心路由器上甚至公网上提供 DNS 服务，如果你只是简单地在局域网环境使用，则使用 Cloudflare 提供的 Cloudflared 程序就可以轻松完成部署。")]),t._v(" "),r("hr"),t._v(" "),t._m(2),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),r("p",[t._v("首先需要下载 Cloudflared 二进制文件")]),t._v(" "),r("p",[r("a",{attrs:{href:"https://bin.equinox.io/c/VdrWdbjqyF/cloudflared-stable-windows-386.zip",target:"_blank",rel:"noopener noreferrer"}},[t._v("32 位系统"),r("OutboundLink")],1)]),t._v(" "),r("p",[r("a",{attrs:{href:"https://bin.equinox.io/c/VdrWdbjqyF/cloudflared-stable-windows-amd64.zip",target:"_blank",rel:"noopener noreferrer"}},[t._v("64 位系统"),r("OutboundLink")],1)]),t._v(" "),r("p",[t._v("解压缩后放到任意位置，如我们放到 I 盘的 Cloudflare 文件夹中。")]),t._v(" "),t._m(5),t._v(" "),r("p",[t._v("在左下角的 Windows 徽标按钮上右键单击，选择「Windows PowerShell（管理员）」，并在弹出的 UAC 授权提示框（如果有）中允许 PowerShell 使用管理员权限。")]),t._v(" "),t._m(6),t._v(" "),t._m(7),t._v(" "),t._m(8),t._v(" "),r("p",[t._v("以 DNS 代理模式运行 Cloudflared")]),t._v(" "),t._m(9),t._v(" "),r("p",[t._v("这时我们已经成功通过 Cloudflared 隧道程序以 HTTPS 方式连接到了 Cloudflare 提供的 DNS。")]),t._v(" "),r("p",[t._v("由于 Cloudflared 自身以 CLI（Command Lines）方式运行时不会以 Daemon 方式运行，我们需要通过 PowerShell 的功能来让它在后台运行。")]),t._v(" "),r("p",[t._v("输入命令（你需要自行修改命令中的路径）：")]),t._v(" "),t._m(10),t._m(11),t._v(" "),t._m(12),t._v(" "),t._m(13),t._v(" "),t._m(14),t._v(" "),t._m(15),t._v(" "),r("p",[t._v("将这个 PowerShell 设置为开机运行，就可以实现开机启动 Cloudflared 并运行 DNS 代理服务。")]),t._v(" "),r("p",[t._v("Windows 也可以将 Cloudflared 设置为系统服务来开机运行 Cloudflared，请参考"),r("a",{attrs:{href:"https://developers.cloudflare.com/argo-tunnel/reference/service/",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方文档"),r("OutboundLink")],1)]),t._v(" "),t._m(16),t._v(" "),t._m(17),t._v(" "),t._m(18),t._v(" "),r("p",[t._v("macOS 系统可以通过包管理器或二进制安装 Cloudflared。")]),t._v(" "),r("p",[t._v("要安装 Homebrew（包管理器），你可以参考 Homebrew 的官方网站或直接在终端中输入：")]),t._v(" "),t._m(19),r("p",[t._v("已经安装 Homebrew 后，在终端中输入：")]),t._v(" "),t._m(20),r("p",[t._v("也可以直接使用二进制文件安装：")]),t._v(" "),t._m(21),t._m(22),t._v(" "),r("p",[t._v("Cloudflared 以 DNS 代理模式运行时需要监听 53 端口，因此必须提权到 Root 用户才能运行。")]),t._v(" "),t._m(23),t._v(" "),r("p",[t._v("要在后台运行 Cloudflared，官方方法是将 Cloudflared 设置为服务。")]),t._v(" "),r("p",[t._v("要设置 Cloudflared 为服务，你必须拥有一个 Cloudflare 账户并在至少一个域中购买了 Argo 增值服务。")]),t._v(" "),t._m(24),t._v(" "),r("p",[t._v("因此，详细的设置方法请参考"),r("a",{attrs:{href:"https://developers.cloudflare.com/argo-tunnel/reference/service/",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方文档"),r("OutboundLink")],1)]),t._v(" "),r("p",[t._v("macOS 也可以自行编写脚本来开机运行 Cloudflared，但是由于 macOS 是类 UNIX 系统且权限控制较为严格，此文档没有足够篇幅和必要介绍此种方法。")]),t._v(" "),t._m(25),t._v(" "),t._m(26),t._v(" "),t._m(27),t._v(" "),r("p",[t._v("Linux 发行版可以通过包管理器安装或二进制安装。")]),t._v(" "),r("p",[r("a",{attrs:{href:"https://bin.equinox.io/c/VdrWdbjqyF/cloudflared-stable-linux-amd64.tgz",target:"_blank",rel:"noopener noreferrer"}},[t._v("二进制文件 x86-64"),r("OutboundLink")],1),t._v(" | "),r("a",{attrs:{href:"https://bin.equinox.io/c/VdrWdbjqyF/cloudflared-stable-linux-arm.tgz",target:"_blank",rel:"noopener noreferrer"}},[t._v("二进制文件 ARMv6"),r("OutboundLink")],1)]),t._v(" "),r("p",[r("a",{attrs:{href:"https://bin.equinox.io/c/VdrWdbjqyF/cloudflared-stable-linux-amd64.deb",target:"_blank",rel:"noopener noreferrer"}},[t._v(".deb 包 x86-64"),r("OutboundLink")],1),t._v(" | "),r("a",{attrs:{href:"https://bin.equinox.io/c/VdrWdbjqyF/cloudflared-stable-linux-arm.deb",target:"_blank",rel:"noopener noreferrer"}},[t._v(".deb 包 ARMv6"),r("OutboundLink")],1)]),t._v(" "),r("p",[r("a",{attrs:{href:"https://bin.equinox.io/c/VdrWdbjqyF/cloudflared-stable-linux-amd64.rpm",target:"_blank",rel:"noopener noreferrer"}},[t._v(".rpm 包 x86-64"),r("OutboundLink")],1),t._v(" | "),r("a",{attrs:{href:"https://bin.equinox.io/c/VdrWdbjqyF/cloudflared-stable-linux-arm.rpm",target:"_blank",rel:"noopener noreferrer"}},[t._v(".rpm 包 ARMv6"),r("OutboundLink")],1)]),t._v(" "),t._m(28),t._v(" "),r("p",[t._v("Cloudflared 以 DNS 代理模式运行时需要监听 53 端口，因此必须提权到 Root 用户才能运行。如果已经是 Root 用户，直接运行即可。")]),t._v(" "),r("p",[t._v("可以在 screen 中运行 Cloudflared 以变相达成后台运行，或者自行编写 SystemInitV / Systemd 脚本来开机运行。")])])},[function(){var t=this.$createElement,e=this._self._c||t;return e("h1",{attrs:{id:"dns-over-https"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#dns-over-https","aria-hidden":"true"}},[this._v("#")]),this._v(" DNS over HTTPS")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"概述"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#概述","aria-hidden":"true"}},[this._v("#")]),this._v(" 概述")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"windows"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#windows","aria-hidden":"true"}},[this._v("#")]),this._v(" Windows")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"系统环境"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#系统环境","aria-hidden":"true"}},[this._v("#")]),this._v(" 系统环境")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"tip custom-block"},[e("p",{staticClass:"custom-block-title"},[this._v("在此文章撰写时...")]),this._v(" "),e("p",[this._v("Windows 10 Pro for Workstations / 1804. Build 17134.1")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"http://pcimbvi1w.bkt.clouddn.com/olafx.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"http://pcimbvi1w.bkt.clouddn.com/rbtat.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("定位到"),e("code",[this._v("I:\\Cloudflare")]),this._v("目录。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"http://pcimbvi1w.bkt.clouddn.com/791b3.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"http://pcimbvi1w.bkt.clouddn.com/tg9om.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v('powershell -windowstyle hidden -command "I:\\Cloudflare\\cloudflared.exe proxy-dns"\n')])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"warning custom-block"},[e("p",{staticClass:"custom-block-title"},[this._v("WARNING")]),this._v(" "),e("p",[this._v("某些安全软件可能会拦截以后台静默运行的程序，请允许 Cloudflared.exe 和 PowerShell 这么做")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"http://pcimbvi1w.bkt.clouddn.com/jmrkh.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("可以看到 PowerShell 窗口一闪而过，我们通过"),e("code",[this._v("nslookup")]),this._v("测试一下。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"http://pcimbvi1w.bkt.clouddn.com/u8jc9.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("测试可以了解到，Cloudflared 仍然在正常运行，并提供着 DNS 代理服务。现在，只需要修改网络适配器中的 DNS 服务器地址为"),e("code",[this._v("127.0.0.1")]),this._v("就可以使用了。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"macos"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#macos","aria-hidden":"true"}},[this._v("#")]),this._v(" macOS")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"系统环境-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#系统环境-2","aria-hidden":"true"}},[this._v("#")]),this._v(" 系统环境")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"warning custom-block"},[e("p",{staticClass:"custom-block-title"},[this._v("在此文章撰写时...")]),this._v(" "),e("p",[this._v("macOS 10.13.5 Beta / Build 17F45c")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v('/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"\n')])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("brew install cloudflare/cloudflare/cloudflared\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("curl https://bin.equinox.io/c/VdrWdbjqyF/cloudflared-stable-darwin-amd64.tgz | tar xzC /usr/local/bin\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("安装后直接在终端输入"),e("code",[this._v("sudo cloudflared proxy-dns")]),this._v("即可运行 Cloudflared 的 DNS 代理功能。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"http://pcimbvi1w.bkt.clouddn.com/5z51t.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"http://pcimbvi1w.bkt.clouddn.com/hs5zh.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"linux"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#linux","aria-hidden":"true"}},[this._v("#")]),this._v(" Linux")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"系统环境-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#系统环境-3","aria-hidden":"true"}},[this._v("#")]),this._v(" 系统环境")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"tip custom-block"},[e("p",{staticClass:"custom-block-title"},[this._v("在此文章撰写时...")]),this._v(" "),e("p",[this._v("Rad Hat Enterprise Linux 7.4"),e("br"),this._v("\nUbuntu 18.04 LTS")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("二进制文件可以直接安装到"),e("code",[this._v("/usr/bin")]),this._v("等目录，安装后，输入"),e("code",[this._v("sudo cloudflared proxy-dns")]),this._v("就可以使用，可以部署到路由器上供网关下的设备使用。")])}],!1,null,null,null);e.default=a.exports}}]);